<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Internship & Placement Gateway</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        .animated-gradient-text {
            background: linear-gradient(90deg, #8b5cf6, #d946ef, #ec4899, #f97316);
            background-size: 250% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient-flow 8s ease infinite;
        }
        @keyframes gradient-flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .card-hover {
            transition: all 0.3s ease-in-out;
        }
        .card-hover:hover {
            transform: translateY(-8px);
            box-shadow: 0 0 30px rgba(217, 70, 239, 0.3); /* fuchsia glow */
        }
        .modal-backdrop {
            background-color: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(4px);
        }
        .nav-link {
            position: relative;
            transition: all 0.3s;
            padding-bottom: 8px;
            font-weight: 500;
        }
        .nav-link::after {
            content: '';
            position: absolute;
            bottom: -1px; /* Align with the border-b of the header */
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background: linear-gradient(90deg, #8b5cf6, #ec4899);
            border-radius: 2px;
            transition: width 0.3s ease-in-out;
        }
        .nav-link.active::after, .nav-link:hover::after {
            width: 100%;
        }
        .nav-link.active {
            color: #1e293b;
        }
        .view-section {
            animation: fadeIn 0.6s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
            to { transform: rotate(300deg); }
        }
        .loader {
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        .carousel-container {
            scroll-behavior: smooth;
            scrollbar-width: none;
        }
        .carousel-container::-webkit-scrollbar {
            display: none;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
        }
        .listening-indicator {
            animation: pulse 1.5s infinite;
        }
        .sort-tab.active {
            color: #1e293b;
            border-bottom-width: 2px;
            border-color: #1e293b;
        }
    </style>
</head>
<body class="bg-gray-50 text-slate-800">

    <!-- Title and Search Section -->
    <div class="bg-white pt-8 pb-6 px-6 shadow-sm">
        <div class="container mx-auto">
            <h1 class="text-5xl font-extrabold animated-gradient-text text-center mb-6">Prepify</h1>
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="relative w-full">
                     <input type="text" id="main-search-bar" placeholder="Search for internships, skills, or companies..." class="w-full pl-12 pr-4 py-3 bg-gray-50 border-2 border-slate-200 rounded-full shadow-inner focus:outline-none focus:ring-2 focus:ring-purple-500 text-base">
                     <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-slate-400"></i>
                </div>
                 <div id="auth-buttons" class="flex items-center space-x-4 md:ml-8">
                    <button id="login-btn-header" class="font-bold px-6 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-pink-500 text-white hover:opacity-90 transition-opacity flex-shrink-0">Log In</button>
                    <button id="signup-btn-header" class="font-bold px-6 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-pink-500 text-white hover:opacity-90 transition-opacity flex-shrink-0">Sign Up</button>
                </div>
                <div id="user-greeting" class="hidden items-center space-x-4 md:ml-8">
                    <span id="user-name" class="font-bold text-slate-700"></span>
                    <button id="logout-btn" class="font-bold px-6 py-2 rounded-lg bg-slate-200 text-slate-800 hover:bg-slate-300 transition-colors flex-shrink-0">Log Out</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Bar -->
    <header class="bg-white/80 backdrop-blur-md border-b border-slate-200 sticky top-0 z-40">
        <div class="container mx-auto px-6">
            <div class="flex justify-center items-center h-16">
                <nav id="main-nav" class="flex items-center space-x-6 md:space-x-10 text-slate-500 font-medium">
                    <!-- Nav buttons are injected here by JS -->
                </nav>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-6">

        <!-- Home View -->
        <div id="home-view" class="view-section">
             <div class="relative rounded-lg overflow-hidden h-[450px] mb-16 mt-6">
                 <img src="https://images.unsplash.com/photo-1522071820081-009f0129c71c?q=80&w=2070&auto=format&fit=crop" class="absolute w-full h-full object-cover" alt="Students collaborating">
                 <div class="absolute inset-0 bg-black bg-opacity-40"></div>
                 <div class="absolute inset-0 flex items-center justify-center">
                     <div class="text-center text-white p-8 bg-black/40 backdrop-blur-sm rounded-lg shadow-lg max-w-2xl mx-4">
                         <h2 class="text-5xl font-extrabold mb-4 leading-tight">Unlock Your Career Potential</h2>
                         <p class="text-xl leading-relaxed">Prepify is your launchpad. Sharpen skills with our learning resources, practice with AI interview prep, and land internships that lead to careers.</p>
                     </div>
                 </div>
             </div>

             <div class="py-16">
                 <div class="relative rounded-lg overflow-hidden h-[500px]">
                      <img src="https://images.unsplash.com/photo-1521737604893-d14cc237f11d?q=80&w=2070&auto=format&fit=crop" class="absolute w-full h-full object-cover" alt="Team collaborating in a modern office">
                      <div class="absolute inset-0 bg-black/50"></div>
                      <div class="absolute inset-0 flex items-center justify-center">
                          <div class="text-center text-white max-w-3xl mx-4 p-8 bg-black/30 backdrop-blur-sm rounded-lg">
                              <h3 class="text-4xl font-extrabold mb-6">Your All-in-One Career Toolkit.</h3>
                              <p class="text-lg mb-6 leading-relaxed">Prepify isn't just a portal; it's a comprehensive ecosystem designed for ambitious students. We bridge the gap between education and employment by providing:</p>
                              <ul class="list-none space-y-5 text-lg inline-block text-left">
                                  <li class="flex items-start"><i class="fas fa-book-open text-purple-400 mt-1 mr-4"></i><div><strong>Targeted Learning:</strong> Resources to build the exact skills employers are looking for.</div></li>
                                  <li class="flex items-start"><i class="fas fa-robot text-pink-400 mt-1 mr-4"></i><div><strong>Realistic Practice:</strong> AI-powered interview simulations that build real confidence.</div></li>
                                  <li class="flex items-start"><i class="fas fa-briefcase text-orange-400 mt-1 mr-4"></i><div><strong>Career Opportunities:</strong> Curated internships with a high chance of leading to full-time roles.</div></li>
                              </ul>
                          </div>
                      </div>
                 </div>
             </div>

            <div class="mb-12">
                <h3 class="text-3xl font-bold mb-2">A broad selection of opportunities</h3>
                <p class="text-lg text-slate-500 mb-8">Choose from thousands of internship opportunities with new additions published every month.</p>
                
                <div id="sort-tabs" class="flex space-x-8 border-b mb-8">
                    <button data-sort="popular" class="sort-tab font-bold pb-3 active">Most Popular</button>
                    <button data-sort="rated" class="sort-tab font-bold pb-3 text-slate-500 hover:text-slate-800">Top Rated</button>
                    <button data-sort="newest" class="sort-tab font-bold pb-3 text-slate-500 hover:text-slate-800">Newest</button>
                </div>

                <div class="relative">
                    <div id="internship-carousel" class="flex overflow-x-auto gap-6 carousel-container pb-4">
                        <!-- Internship carousel cards will be injected here -->
                    </div>
                    <button id="internship-prev" class="absolute top-1/2 -left-5 -translate-y-1/2 bg-white rounded-full shadow-lg w-12 h-12 text-2xl z-10 hover:bg-gray-200 hidden md:flex items-center justify-center"><i class="fas fa-chevron-left"></i></button>
                    <button id="internship-next" class="absolute top-1/2 -right-5 -translate-y-1/2 bg-white rounded-full shadow-lg w-12 h-12 text-2xl z-10 hover:bg-gray-200 hidden md:flex items-center justify-center"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </div>
        
        <!-- Dashboard View -->
        <div id="dashboard-view" class="view-section hidden">
            <h2 class="text-4xl font-extrabold text-slate-900 mb-8">My Dashboard</h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 space-y-8">
                    <!-- Saved Internships -->
                    <div>
                        <h3 class="text-2xl font-bold text-slate-800 mb-4">Saved Internships</h3>
                        <div id="saved-internships-container" class="space-y-4"></div>
                    </div>
                     <!-- Application History -->
                    <div>
                        <h3 class="text-2xl font-bold text-slate-800 mb-4">Application History</h3>
                        <div id="application-history-container" class="bg-white rounded-lg shadow-md p-4"></div>
                    </div>
                </div>
                <div class="space-y-8">
                     <!-- My Badges -->
                    <div>
                        <h3 class="text-2xl font-bold text-slate-800 mb-4">My Badges</h3>
                        <div id="my-badges-container" class="flex flex-wrap gap-4"></div>
                    </div>
                     <!-- AI Recommendations -->
                    <div class="bg-violet-50/50 border-2 border-dashed border-violet-200 rounded-2xl p-6">
                         <h3 class="text-2xl font-bold text-slate-900 mb-2">✨ AI Recommendations</h3>
                         <p class="text-slate-600 mb-4">Based on your activity, here are some top matches for you.</p>
                         <button id="get-recommendations-btn" class="w-full flex justify-center items-center gap-2 text-white font-bold py-2 px-6 rounded-lg bg-gradient-to-r from-purple-600 to-pink-500">Get Recommendations</button>
                         <div id="recommendations-result" class="mt-4 hidden text-sm"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Internships (Student) View -->
        <div id="internships-view" class="view-section hidden">
            <div class="text-center my-6">
                <h2 class="text-4xl font-extrabold text-slate-900 mb-2">Curated Internship Opportunities</h2>
                <p class="text-lg text-slate-500">Discover roles that offer a direct path to a full-time career.</p>
            </div>
            <div id="internship-listings" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- All internship cards will be injected here -->
            </div>
        </div>

        <!-- Learning Hub View -->
        <div id="learning-view" class="view-section hidden">
            <div class="text-center my-6">
                <h2 class="text-4xl font-extrabold text-slate-900 mb-2">Learning Hub</h2>
                <p class="text-lg text-slate-500">Sharpen your skills with our curated collection of resources.</p>
            </div>

            <div class="bg-violet-50/50 border-2 border-dashed border-violet-200 rounded-2xl p-8 mb-12">
                <h3 class="text-3xl font-bold text-slate-900 mb-2">✨ Create Your Personalized Learning Path</h3>
                <p class="text-slate-600 mb-6">Tell us your career goal, and our AI will generate a custom learning plan for you.</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="text" id="career-goal-input" placeholder="e.g., Become a Backend Developer" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition">
                    <button id="generate-path-btn" class="flex justify-center items-center gap-2 text-white font-bold py-3 px-8 rounded-lg bg-gradient-to-r from-purple-600 to-pink-500 hover:from-purple-700 hover:to-pink-600 transition-all">Generate Path</button>
                </div>
                <div id="learning-path-result" class="mt-8 hidden p-6 bg-white rounded-lg border border-slate-200"></div>
            </div>

            <div class="bg-white rounded-2xl shadow-lg p-8 mb-12 border border-slate-200">
                <h3 class="text-3xl font-bold text-slate-900 mb-2">Test Your Knowledge</h3>
                <p class="text-slate-600 mb-6">Take a quick AI-generated quiz to earn a skill badge!</p>
                <button id="take-quiz-btn" class="text-white font-bold py-3 px-8 rounded-lg bg-gradient-to-r from-pink-600 to-orange-500 hover:opacity-90 transition-opacity">Take a Quiz ✨</button>
            </div>

            <div id="learning-resources" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            </div>
        </div>

        <!-- Interview Prep View -->
        <div id="interview-view" class="view-section hidden">
            <div class="text-center my-6">
                <h2 class="text-4xl font-extrabold text-slate-900 mb-2">AI-Powered Interview Prep</h2>
                <p class="text-lg text-slate-500">Simulate real interviews and get instant, actionable feedback.</p>
            </div>
            <div id="interview-container" class="max-w-4xl mx-auto bg-white/60 backdrop-blur-sm p-8 sm:p-10 rounded-2xl shadow-xl shadow-purple-100/50 border border-slate-200">
            </div>
        </div>

        <!-- Company View -->
        <div id="company-view" class="view-section hidden">
            <div class="text-center my-6">
                <h2 class="text-4xl font-extrabold text-slate-900 mb-2">Partner With Excellence</h2>
                <p class="text-lg text-slate-500">Recruit top talent through our "Purpose-Process-Placement" framework.</p>
            </div>
            <div class="max-w-4xl mx-auto bg-white p-10 rounded-2xl shadow-lg border border-slate-200">
                <h3 class="text-3xl font-bold text-slate-900 mb-6">Our 3-P Framework</h3>
                <ol class="list-decimal list-inside space-y-6 text-slate-600 text-lg">
                     <li><span class="font-semibold text-purple-700">Purpose:</span> We help you define clear, meaningful project goals for interns that align with your business objectives, ensuring a purposeful experience.</li>
                     <li><span class="font-semibold text-pink-600">Process:</span> Our platform encourages best practices like dedicated mentorship and structured feedback, processes proven to boost performance and engagement.</li>
                     <li><span class="font-semibold text-orange-500">Placement:</span> By focusing on skill development and performance tracking, our framework naturally identifies high-potential candidates, creating a seamless pipeline to full-time placement.</li>
                </ol>
                <div class="text-center mt-10">
                    <button class="text-white font-bold py-3 px-8 rounded-lg bg-gradient-to-r from-purple-600 to-pink-500 hover:from-purple-700 hover:to-pink-600 transition-all duration-300 text-lg">Post an Internship</button>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Modals -->
    <div id="application-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-lg mx-4 border border-slate-200">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-slate-900">Apply for <span id="modal-job-title" class="animated-gradient-text"></span></h3>
                <button class="close-modal-btn text-slate-500 hover:text-slate-800 text-3xl">&times;</button>
            </div>
            <form id="application-form">
                <input type="hidden" id="modal-job-id">
                <div class="mb-4">
                    <label for="name" class="block text-slate-700 font-semibold mb-2">Full Name</label>
                    <input type="text" id="name" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition" required>
                </div>
                <div class="mb-4">
                    <label for="email" class="block text-slate-700 font-semibold mb-2">Email Address</label>
                    <input type="email" id="email" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition" required>
                </div>
                <div class="mb-6">
                    <label for="resume-content" class="block text-slate-700 font-semibold mb-2">Your Resume Content</label>
                    <textarea id="resume-content" placeholder="Paste your resume content here for AI analysis..." class="w-full h-24 p-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition" required></textarea>
                </div>
                
                <div class="flex gap-4 mb-6">
                    <button type="button" id="improve-resume-btn" class="w-full flex justify-center items-center gap-2 text-purple-700 font-bold py-2.5 px-6 rounded-lg bg-purple-100 hover:bg-purple-200 transition-all">
                        ✨ Improve Resume
                    </button>
                    <button type="button" id="generate-cover-letter-btn" class="w-full flex justify-center items-center gap-2 text-pink-700 font-bold py-2.5 px-6 rounded-lg bg-pink-100 hover:bg-pink-200 transition-all">
                        ✨ Generate Cover Letter
                    </button>
                </div>
                <div id="ai-helper-output" class="mt-4 hidden p-4 bg-slate-50 rounded-lg border border-slate-200 text-sm"></div>

                <div class="text-right">
                    <button type="submit" class="text-white font-bold py-2 px-6 rounded-lg bg-gradient-to-r from-purple-600 to-pink-500 hover:from-purple-700 hover:to-pink-600 transition-colors duration-300">Submit Application</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="day-in-life-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-lg mx-4 border border-slate-200 relative">
            <button class="close-modal-btn absolute top-4 right-4 text-slate-500 hover:text-slate-800 text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-slate-900 mb-4">A Day in the Life of a <span id="day-modal-job-title" class="animated-gradient-text"></span></h3>
            <div id="day-in-life-content" class="text-slate-600 leading-relaxed"></div>
        </div>
    </div>

    <div id="login-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md mx-4 border border-slate-200">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-slate-900">Log In</h3>
                <button class="close-modal-btn text-slate-500 hover:text-slate-800 text-3xl">&times;</button>
            </div>
            <form id="login-form">
                <div class="mb-4">
                    <label for="login-email" class="block text-slate-700 font-semibold mb-2">Email Address</label>
                    <input type="email" id="login-email" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition" required>
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-slate-700 font-semibold mb-2">Password</label>
                    <input type="password" id="login-password" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition" required>
                </div>
                <div id="login-error" class="text-red-500 text-sm mb-4 hidden"></div>
                <div class="text-right">
                    <button type="submit" class="text-white font-bold py-2 px-6 rounded-lg bg-gradient-to-r from-purple-600 to-pink-500 hover:from-purple-700 hover:to-pink-600 transition-colors duration-300">Log In</button>
                </div>
            </form>
        </div>
    </div>

     <div id="signup-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md mx-4 border border-slate-200">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-slate-900">Sign Up</h3>
                <button class="close-modal-btn text-slate-500 hover:text-slate-800 text-3xl">&times;</button>
            </div>
            <form id="signup-form">
                 <div class="mb-4">
                    <label for="signup-name" class="block text-slate-700 font-semibold mb-2">Full Name</label>
                    <input type="text" id="signup-name" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition" required>
                </div>
                <div class="mb-4">
                    <label for="signup-email" class="block text-slate-700 font-semibold mb-2">Email Address</label>
                    <input type="email" id="signup-email" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition" required>
                </div>
                <div class="mb-6">
                    <label for="signup-password" class="block text-slate-700 font-semibold mb-2">Password</label>
                    <input type="password" id="signup-password" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition" required>
                </div>
                <div id="signup-error" class="text-red-500 text-sm mb-4 hidden"></div>
                <div class="text-right">
                    <button type="submit" class="text-white font-bold py-2 px-6 rounded-lg bg-gradient-to-r from-purple-600 to-pink-500 hover:from-purple-700 hover:to-pink-600 transition-colors duration-300">Create Account</button>
                </div>
            </form>
        </div>
    </div>

    <div id="quiz-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div id="quiz-container" class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-2xl mx-4 border border-slate-200">
            <!-- Quiz content injected by JS -->
        </div>
    </div>

    <!-- Success Notification -->
    <div id="success-notification" class="fixed top-5 right-5 bg-gradient-to-r from-green-400 to-teal-500 text-white py-3 px-6 rounded-lg shadow-lg transform translate-x-[120%] transition-transform duration-500 flex items-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
        <span id="notification-text" class="font-semibold"></span>
    </div>

    <footer class="bg-gray-800 text-white mt-20">
        <div class="container mx-auto px-6 py-12">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-8">
                <div>
                    <h4 class="font-bold mb-4">Prepify</h4>
                    <ul>
                        <li class="mb-2"><a href="#" class="hover:underline">About Us</a></li>
                        <li class="mb-2"><a href="#" class="hover:underline">Careers</a></li>
                        <li class="mb-2"><a href="#" class="hover:underline">Press</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-bold mb-4">For Students</h4>
                    <ul>
                        <li class="mb-2"><a href="#" class="hover:underline">Internships</a></li>
                        <li class="mb-2"><a href="#" class="hover:underline">Learning Hub</a></li>
                        <li class="mb-2"><a href="#" class="hover:underline">Interview Prep</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-bold mb-4">For Companies</h4>
                    <ul>
                        <li class="mb-2"><a href="#" class="hover:underline">Post an Internship</a></li>
                        <li class="mb-2"><a href="#" class="hover:underline">Our Framework</a></li>
                        <li class="mb-2"><a href="#" class="hover:underline">Success Stories</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-bold mb-4">Connect</h4>
                    <div class="flex space-x-4 text-2xl">
                        <a href="#" class="hover:text-violet-400"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="hover:text-violet-400"><i class="fab fa-linkedin"></i></a>
                        <a href="#" class="hover:text-violet-400"><i class="fab fa-instagram"></i></a>
                    </div>
                </div>
            </div>
            <div class="mt-12 border-t border-gray-700 pt-8 flex justify-between items-center">
                <p>&copy; 2025 Prepify, Inc.</p>
                <h1 class="text-2xl font-bold animated-gradient-text">Prepify</h1>
            </div>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut,
            updateProfile,
            signInAnonymously,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            setDoc,
            deleteDoc,
            onSnapshot,
            query,
            where,
            getDocs,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', function() {
            // --- FIREBASE SETUP ---
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            
            let app, auth, db;
            let currentUserId = null;
            let firestoreUnsubscribers = [];

            // --- DATA ---
            const internships = [ 
                { id: 'swe1', title: 'Software Engineer Intern', company: 'TechCorp Solutions', location: 'Remote', duration: '6 Months', stipend: '₹40,000/month', ppoChance: 'High', skills: ['Python', 'React', 'AWS'], mentor: true, rating: 4.8, postedDate: '2025-09-15T10:00:00Z' }, 
                { id: 'ds1', title: 'Data Science Intern', company: 'InnovateStart Pvt. Ltd.', location: 'Bangalore', duration: '3 Months', stipend: '₹25,000/month', ppoChance: 'Medium', skills: ['Machine Learning', 'SQL', 'Pandas'], mentor: true, rating: 4.6, postedDate: '2025-09-28T11:00:00Z' }, 
                { id: 'pm1', title: 'Product Management Intern', company: 'Future Gadgets', location: 'Hybrid (Delhi)', duration: '4 Months', stipend: '₹30,000/month', ppoChance: 'Medium', skills: ['JIRA', 'Market Research', 'Agile'], mentor: false, rating: 4.5, postedDate: '2025-09-10T09:00:00Z' },
                { id: 'ux1', title: 'UI/UX Design Intern', company: 'Creative Minds', location: 'Remote', duration: '3 Months', stipend: '₹22,000/month', ppoChance: 'High', skills: ['Figma', 'Adobe XD', 'User Research'], mentor: true, rating: 4.9, postedDate: '2025-10-01T14:00:00Z' },
                { id: 'mkt1', title: 'Marketing Intern', company: 'Brand Boosters', location: 'Mumbai', duration: '6 Months', stipend: '₹18,000/month', ppoChance: 'Low', skills: ['SEO', 'Content Writing', 'Social Media'], mentor: false, rating: 4.2, postedDate: '2025-08-25T12:00:00Z' },
                { id: 'be1', title: 'Backend Developer Intern', company: 'DataWeave', location: 'Remote', duration: '4 Months', stipend: '₹35,000/month', ppoChance: 'High', skills: ['Node.js', 'Express', 'MongoDB'], mentor: true, rating: 4.7, postedDate: '2025-09-25T18:00:00Z' },
                { id: 'cld1', title: 'Cloud Engineer Intern', company: 'SkyHigh Infra', location: 'Pune', duration: '6 Months', stipend: '₹30,000/month', ppoChance: 'Medium', skills: ['AWS', 'Docker', 'Terraform'], mentor: true, rating: 4.5, postedDate: '2025-09-18T10:00:00Z' },
                { id: 'mob1', title: 'Mobile App Dev Intern', company: 'Appify', location: 'Hybrid (Bangalore)', duration: '3 Months', stipend: '₹28,000/month', ppoChance: 'High', skills: ['Flutter', 'Firebase', 'Dart'], mentor: true, rating: 4.8, postedDate: '2025-09-30T15:00:00Z' },
                { id: 'sec1', title: 'Cybersecurity Analyst Intern', company: 'SecureNet', location: 'Remote', duration: '6 Months', stipend: '₹32,000/month', ppoChance: 'Medium', skills: ['Penetration Testing', 'Wireshark', 'Metasploit'], mentor: false, rating: 4.4, postedDate: '2025-09-05T11:00:00Z' },
                { id: 'dev1', title: 'DevOps Intern', company: 'DeployFast', location: 'Remote', duration: '5 Months', stipend: '₹38,000/month', ppoChance: 'High', skills: ['CI/CD', 'Jenkins', 'Kubernetes'], mentor: true, rating: 4.7, postedDate: '2025-09-22T16:00:00Z' },
            ];
            const learningResources = [ 
                { title: 'React for Beginners', category: 'Frontend', type: 'Video Course' }, 
                { title: 'Advanced CSS Grids', category: 'Frontend', type: 'Article' }, 
                { title: 'Node.js & Express API', category: 'Backend', type: 'Tutorial' }, 
                { title: 'Database Design Principles', category: 'Backend', type: 'Article' }, 
                { title: 'Intro to Python for ML', category: 'Data Science', type: 'Video Course' }, 
                { title: 'Pandas Dataframes', category: 'Data Science', type: 'Tutorial' }, 
                { title: 'Figma Design Fundamentals', category: 'Design', type: 'Video Course' }, 
                { title: 'Case Study: Solving User Problems', category: 'Product', type: 'Article' },
                { title: 'AWS Certified Cloud Practitioner', category: 'Cloud', type: 'Video Course' },
                { title: 'Docker for Beginners', category: 'DevOps', type: 'Tutorial' },
                { title: 'Introduction to CI/CD', category: 'DevOps', type: 'Article' },
                { title: 'SQL for Data Analysis', category: 'Data Science', type: 'Tutorial' }
            ];
            const interviewQuestions = {
                frontend: [ 'Explain the difference between `let`, `const`, and `var`.', 'What is the component lifecycle in React?', 'How would you make a website responsive?', 'Describe the differences between `null` and `undefined` in JavaScript.', 'What is "prop drilling" in React and how can you avoid it?', 'Explain the concept of memoization in the context of React.', 'Describe a situation where you had to optimize a slow-loading web page.'],
                backend: ['What is the difference between SQL and NoSQL databases?', 'Explain the request-response cycle in a web application.', 'Describe RESTful APIs and their principles.', 'What is the purpose of indexing in a database?', 'Explain the concept of microservices architecture.', 'How would you design a simple URL shortening service like TinyURL?', 'Describe different types of caching strategies you might use in a backend application.'],
                'data-science': ['Explain the difference between supervised and unsupervised learning.', 'What is overfitting and how can you prevent it?', 'Describe the process of cleaning a dataset.', 'Explain the bias-variance tradeoff in machine learning.', 'What are Type I and Type II errors?', 'Describe how a decision tree works.', 'How would you approach a problem where the dataset is highly imbalanced?'],
                'cloud': ['What is virtualization?', 'Explain the difference between IaaS, PaaS, and SaaS.', 'What is a VPC in the context of cloud computing?', 'Describe the concept of auto-scaling.', 'What is the purpose of a load balancer?', 'Compare and contrast serverless computing with container-based deployment.', 'How would you secure a cloud environment?'],
                'devops': ['What is CI/CD and why is it important?', 'Explain the purpose of Docker and containers.', 'What is Infrastructure as Code (IaC)?', 'Describe the difference between a virtual machine and a container.', 'What is the role of a configuration management tool like Ansible or Puppet?', 'Explain the concept of blue-green deployment.', 'How would you monitor a distributed system in production?'],
                'product-management': ['How would you prioritize features for a new product?', 'What is your favorite product and why?', 'Describe the product development lifecycle.', 'How do you define and measure the success of a product?', 'Walk me through how you would design a new feature for a popular app.', 'How would you handle a situation where stakeholders have conflicting priorities?', 'What is the difference between a product manager and a project manager?']
            };

            // --- USER DATA (Now sourced from Firestore) ---
            let savedInternships = [];
            let appliedInternships = [];
            let earnedBadges = [];

            // --- ELEMENTS ---
            const mainNav = document.getElementById('main-nav');
            const viewSections = document.querySelectorAll('.view-section');
            const listingsContainer = document.getElementById('internship-listings');
            const internshipCarousel = document.getElementById('internship-carousel');
            const internshipPrevBtn = document.getElementById('internship-prev');
            const internshipNextBtn = document.getElementById('internship-next');
            const modal = document.getElementById('application-modal');
            const modalJobTitle = document.getElementById('modal-job-title');
            const modalJobIdInput = document.getElementById('modal-job-id');
            const applicationForm = document.getElementById('application-form');
            const successNotification = document.getElementById('success-notification');
            const notificationText = document.getElementById('notification-text');
            const learningContainer = document.getElementById('learning-resources');
            const interviewContainer = document.getElementById('interview-container');
            const improveResumeBtn = document.getElementById('improve-resume-btn');
            const generateCoverLetterBtn = document.getElementById('generate-cover-letter-btn');
            const aiHelperOutput = document.getElementById('ai-helper-output');
            const resumeContent = document.getElementById('resume-content');
            const generatePathBtn = document.getElementById('generate-path-btn');
            const careerGoalInput = document.getElementById('career-goal-input');
            const learningPathResult = document.getElementById('learning-path-result');
            const dayInLifeModal = document.getElementById('day-in-life-modal');
            const dayModalJobTitle = document.getElementById('day-modal-job-title');
            const dayInLifeContent = document.getElementById('day-in-life-content');
            const searchBar = document.getElementById('main-search-bar');
            const sortTabsContainer = document.getElementById('sort-tabs');
            const takeQuizBtn = document.getElementById('take-quiz-btn');
            const quizModal = document.getElementById('quiz-modal');
            const quizContainer = document.getElementById('quiz-container');
            
            // Auth elements
            const loginModal = document.getElementById('login-modal');
            const signupModal = document.getElementById('signup-modal');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const loginBtnHeader = document.getElementById('login-btn-header');
            const signupBtnHeader = document.getElementById('signup-btn-header');
            const authButtons = document.getElementById('auth-buttons');
            const userGreeting = document.getElementById('user-greeting');
            const userNameEl = document.getElementById('user-name');
            const logoutBtn = document.getElementById('logout-btn');
            const loginError = document.getElementById('login-error');
            const signupError = document.getElementById('signup-error');

            // Dashboard elements
            const savedInternshipsContainer = document.getElementById('saved-internships-container');
            const applicationHistoryContainer = document.getElementById('application-history-container');
            const myBadgesContainer = document.getElementById('my-badges-container');
            const getRecommendationsBtn = document.getElementById('get-recommendations-btn');
            const recommendationsResult = document.getElementById('recommendations-result');
            
            let currentTrack = '';
            let questionIndex = 0;
            let userAnswers = [];
            let recognition;
            let isLoggedIn = false;

            // --- GEMINI API HELPER ---
            const apiKey = ""; // This will be provided by the environment
            
            async function callGemini(systemPrompt, userQuery) {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) { throw new Error(`API call failed: ${response.status}`); }
                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't get a response.";
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    return "Error contacting AI. Please try again.";
                }
            }
            
            // --- UI TOGGLES ---
            function showLoader(button) {
                button.disabled = true;
                button.dataset.originalText = button.innerHTML;
                button.innerHTML = '<div class="loader mx-auto"></div>';
            }
            function hideLoader(button) {
                button.disabled = false;
                button.innerHTML = button.dataset.originalText;
            }

            // --- RENDER FUNCTIONS ---
            function renderInternshipCard(internship, isCarouselCard = false) {
                 const ppoColors = { High: 'bg-green-100 text-green-800', Medium: 'bg-yellow-100 text-yellow-800', Low: 'bg-red-100 text-red-800' };
                 const cardWidthClass = isCarouselCard ? 'w-80 flex-shrink-0' : '';
                 const isSaved = savedInternships.includes(internship.id);
                 return `
                     <div class="bg-white rounded-xl shadow-md p-6 flex flex-col transition-all duration-300 card-hover border border-slate-200 ${cardWidthClass}">
                         <div class="flex-grow">
                             <div class="flex justify-between items-start mb-2">
                                 <p class="text-md font-semibold text-slate-600">${internship.company}</p>
                                 <span class="text-xs font-semibold px-2.5 py-1 rounded-full ${ppoColors[internship.ppoChance]}">${internship.ppoChance} PPO Chance</span>
                             </div>
                             <h3 class="text-xl font-bold text-slate-900 mb-4">${internship.title}</h3>
                              <div class="mb-4 pt-4 border-t border-slate-100">
                                  <h4 class="font-semibold text-sm mb-2 text-slate-800">Top Skills:</h4>
                                  <div class="flex flex-wrap gap-2">
                                      ${internship.skills.slice(0, 3).map(skill => `<span class="bg-slate-100 text-slate-700 text-xs font-medium px-2 py-1 rounded-md">${skill}</span>`).join('')}
                                  </div>
                              </div>
                         </div>
                         <div class="flex gap-2 mt-2 items-center">
                              <button data-job-id="${internship.id}" class="apply-btn w-full text-white font-bold py-2 px-4 rounded-lg bg-gradient-to-r from-purple-600 to-pink-500 hover:from-purple-700 hover:to-pink-600 transition-all duration-300">Apply</button>
                              <button data-job-id="${internship.id}" class="save-btn text-xl p-2 rounded-full ${isSaved ? 'text-pink-500 bg-pink-100' : 'text-slate-400 hover:bg-slate-100'}">
                                  <i class="fas fa-heart"></i>
                              </button>
                         </div>
                     </div>
                 `;
            }
            
            function populateAllInternships(data = internships) {
                if(listingsContainer) {
                    if (data.length === 0) {
                        listingsContainer.innerHTML = `<p class="text-slate-500 text-center col-span-full">No internships found matching your search.</p>`;
                    } else {
                        listingsContainer.innerHTML = data.map(internship => renderInternshipCard(internship, false)).join('');
                    }
                }
            }
            
            function populateCarousel(data = internships) {
                 if (internshipCarousel) {
                     if (data.length === 0) {
                         internshipCarousel.innerHTML = `<p class="text-slate-500 text-center w-full">No internships found matching your search.</p>`;
                     } else {
                         internshipCarousel.innerHTML = data.map(internship => renderInternshipCard(internship, true)).join('');
                     }
                 }
            }
            
            function renderLearningResources() {
                const icons = {
                    'Video Course': `<i class="fas fa-video text-purple-500 text-2xl"></i>`,
                    'Article': `<i class="fas fa-link text-pink-500 text-2xl"></i>`,
                    'Tutorial': `<i class="fas fa-wrench text-orange-500 text-2xl"></i>`
                };
                if(learningContainer) learningContainer.innerHTML = learningResources.map(resource => `
                    <div class="bg-white rounded-xl shadow-md p-6 flex flex-col items-start transition-all duration-300 card-hover border border-slate-200">
                        <div class="mb-4 h-8">${icons[resource.type] || icons['Article']}</div>
                        <h3 class="text-lg font-bold text-slate-900 mb-1 flex-grow">${resource.title}</h3>
                        <p class="text-sm text-slate-500 mb-4">${resource.category}</p>
                        <span class="text-xs font-semibold px-3 py-1 rounded-full bg-slate-100 text-slate-800 self-start">${resource.type}</span>
                    </div>
                `).join('');
            }

            function renderInterviewUI(state, aiFeedback = "") {
                 if(!interviewContainer) return;
                 let content = '';
                 switch(state) {
                     case 'selection':
                         content = `
                             <div id="interview-selection">
                                 <h3 class="text-2xl font-bold text-slate-900 mb-6 text-center">Choose Your Interview Track</h3>
                                 <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                      <button data-track="frontend" class="interview-track-btn flex flex-col items-center justify-center p-6 border border-slate-200 rounded-lg transition text-slate-700 font-semibold text-lg hover:border-purple-500 hover:text-purple-600 hover:shadow-lg">
                                          <i class="fas fa-code text-3xl mb-3 text-purple-500"></i>
                                          <span>Frontend</span>
                                      </button>
                                      <button data-track="backend" class="interview-track-btn flex flex-col items-center justify-center p-6 border border-slate-200 rounded-lg transition text-slate-700 font-semibold text-lg hover:border-pink-500 hover:text-pink-600 hover:shadow-lg">
                                          <i class="fas fa-server text-3xl mb-3 text-pink-500"></i>
                                          <span>Backend</span>
                                      </button>
                                      <button data-track="data-science" class="interview-track-btn flex flex-col items-center justify-center p-6 border border-slate-200 rounded-lg transition text-slate-700 font-semibold text-lg hover:border-orange-500 hover:text-orange-600 hover:shadow-lg">
                                          <i class="fas fa-brain text-3xl mb-3 text-orange-500"></i>
                                          <span>Data Science</span>
                                      </button>
                                      <button data-track="cloud" class="interview-track-btn flex flex-col items-center justify-center p-6 border border-slate-200 rounded-lg transition text-slate-700 font-semibold text-lg hover:border-blue-500 hover:text-blue-600 hover:shadow-lg">
                                          <i class="fas fa-cloud text-3xl mb-3 text-blue-500"></i>
                                          <span>Cloud</span>
                                      </button>
                                      <button data-track="devops" class="interview-track-btn flex flex-col items-center justify-center p-6 border border-slate-200 rounded-lg transition text-slate-700 font-semibold text-lg hover:border-green-500 hover:text-green-600 hover:shadow-lg">
                                          <i class="fas fa-infinity text-3xl mb-3 text-green-500"></i>
                                          <span>DevOps</span>
                                      </button>
                                      <button data-track="product-management" class="interview-track-btn flex flex-col items-center justify-center p-6 border border-slate-200 rounded-lg transition text-slate-700 font-semibold text-lg hover:border-indigo-500 hover:text-indigo-600 hover:shadow-lg">
                                          <i class="fas fa-lightbulb text-3xl mb-3 text-indigo-500"></i>
                                          <span>Product</span>
                                      </button>
                                 </div>
                             </div>`;
                         interviewContainer.innerHTML = content;
                         interviewContainer.querySelectorAll('.interview-track-btn').forEach(btn => btn.addEventListener('click', () => startInterview(btn.dataset.track)));
                         break;
                     case 'session':
                         const questions = interviewQuestions[currentTrack];
                         const progress = (questionIndex / questions.length) * 100;
                         content = `
                             <div id="interview-session">
                                 <div class="flex justify-between items-center mb-4">
                                     <h3 class="text-2xl font-bold text-slate-900">Interview in Progress...</h3>
                                     <p class="text-sm font-semibold text-slate-500">Track: <span class="text-purple-600">${currentTrack.replace('-', ' ').replace(/\b\w/g, c => c.toUpperCase())}</span></p>
                                 </div>
                                 <div class="w-full bg-gray-200 rounded-full h-2 mb-6"><div class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full" style="width: ${progress}%"></div></div>
                                 <div class="bg-slate-100 p-6 rounded-lg mb-4 border border-slate-200"><p id="question-text" class="text-lg font-semibold text-slate-800">${questions[questionIndex]}</p></div>
                                 <textarea id="answer-input" class="w-full p-4 border border-slate-300 rounded-lg" rows="5" placeholder="Type your answer here or use the voice input..."></textarea>
                                 <div class="flex justify-center items-center gap-4 my-4">
                                     <button id="listen-btn" class="flex items-center gap-2 text-white font-bold py-2 px-6 rounded-full bg-green-500 hover:bg-green-600 transition-colors">
                                         <i class="fas fa-microphone"></i>
                                         <span id="listen-text">Start Listening</span>
                                     </button>
                                 </div>
                                 <div class="flex justify-between items-center mt-4">
                                     <p class="text-sm font-medium text-slate-500">Question ${questionIndex + 1} of ${questions.length}</p>
                                     <button id="next-question-btn" class="text-white font-bold py-2 px-6 rounded-lg bg-gradient-to-r from-purple-600 to-pink-500">Next Question</button>
                                 </div>
                             </div>`;
                         interviewContainer.innerHTML = content;
                         const nextBtn = interviewContainer.querySelector('#next-question-btn');
                         if (questionIndex >= questions.length - 1) {
                             nextBtn.textContent = 'Finish & Get Feedback';
                         }
                         nextBtn.addEventListener('click', handleNextQuestion);
                         interviewContainer.querySelector('#listen-btn').addEventListener('click', toggleListening);
                         speak(questions[questionIndex]);
                         break;
                      case 'loading':
                         content = `
                             <div class="text-center">
                                 <h3 class="text-2xl font-bold text-slate-900 mb-4">Analyzing your answers...</h3>
                                 <p class="text-slate-600 mb-6">Our AI interviewer is reviewing your responses to provide personalized feedback.</p>
                                 <div class="flex justify-center items-center">
                                     <div class="loader" style="border-left-color: #8b5cf6; width: 40px; height: 40px;"></div>
                                 </div>
                             </div>`;
                         interviewContainer.innerHTML = content;
                         break;
                       case 'report':
                         let progressHtml = isLoggedIn ? `
                             <div class="mt-12 p-6 bg-purple-50 rounded-lg border border-purple-200">
                                 <h4 class="text-2xl font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fas fa-chart-line text-purple-600"></i>Progress Tracking</h4>
                                 <p class="text-slate-600 mb-4">Here's how you're improving over time in the ${currentTrack.replace('-', ' ')} track.</p>
                                 <div class="space-y-3">
                                     <div class="flex items-center">
                                         <p class="w-32 font-semibold">Previous Score:</p>
                                         <div class="w-full bg-slate-200 rounded-full h-5"><div class="bg-purple-400 h-5 rounded-full text-xs text-white flex items-center justify-center" style="width: 75%">75%</div></div>
                                     </div>
                                     <div class="flex items-center">
                                         <p class="w-32 font-semibold">This Score:</p>
                                         <div class="w-full bg-slate-200 rounded-full h-5"><div class="bg-purple-600 h-5 rounded-full text-xs text-white flex items-center justify-center" style="width: 85%">85%</div></div>
                                     </div>
                                 </div>
                             </div>` : '';

                         content = `
                             <div id="interview-report">
                                 <h3 class="text-3xl font-bold text-slate-900 mb-8 text-center">Your AI Interview Feedback</h3>
                                 <div class="prose max-w-none text-slate-700 bg-purple-50 p-6 rounded-lg border border-purple-200">
                                     ${aiFeedback.replace(/\n/g, '<br>')}
                                 </div>
                                 ${progressHtml}
                                 <div class="text-center mt-10"><button id="try-again-btn" class="bg-slate-200 text-slate-800 font-bold py-3 px-8 rounded-lg">Try Another Interview</button></div>
                             </div>`;
                         interviewContainer.innerHTML = content;
                         interviewContainer.querySelector('#try-again-btn').addEventListener('click', () => renderInterviewUI('selection'));
                         break;
                }
            }

            // --- LOGIC & EVENT HANDLERS ---
            function switchView(viewId, isSearchTriggered = false) {
                if (!isSearchTriggered && searchBar.value !== '') {
                    searchBar.value = '';
                    populateAllInternships(internships);
                    populateCarousel(internships);
                }
                viewSections.forEach(section => section.classList.add('hidden'));
                const targetView = document.getElementById(viewId);
                targetView.classList.remove('hidden');
                
                const navId = viewId.replace('-view', '');
                const activeLink = document.querySelector(`.nav-link[data-nav="${navId}"]`);
                document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                if(activeLink) activeLink.classList.add('active');

            }
            function startInterview(track) { 
                currentTrack = track; 
                questionIndex = 0; 
                userAnswers = [];
                renderInterviewUI('session'); 
            }
            function handleNextQuestion() {
                const answerInput = document.getElementById('answer-input');
                const questions = interviewQuestions[currentTrack];
                userAnswers.push({
                    question: questions[questionIndex],
                    answer: answerInput.value || "No answer provided."
                });

                if (questionIndex < questions.length - 1) { 
                    questionIndex++; 
                    renderInterviewUI('session'); 
                } else { 
                    generateAIReport();
                }
            }
            async function generateAIReport() {
                renderInterviewUI('loading');
                const systemPrompt = "You are a senior technical interviewer providing feedback on a candidate's performance. The user has completed an interview simulation. You will receive the interview track, a list of questions, and their corresponding answers. Your task is to provide a realistic, professional evaluation. Do not invent fake progress scores. Instead, focus on the quality of their answers. \n\nYour response MUST include:\n1. An overall **Answer Level** assessment (e.g., Beginner, Intermediate, Advanced-Beginner, etc.).\n2. A concise **Overall Summary** of their performance in a short paragraph.\n3. A bulleted list of **Specific Feedback** with 2-3 points on what they did well and what they can improve.\n\nFormat your response using markdown, for example:\n**Answer Level:** Intermediate\n\n**Overall Summary:**\nThe candidate demonstrates a solid foundational knowledge...\n\n**Specific Feedback:**\n* **Good:** Your explanation of the component lifecycle was clear...\n* **Improvement:** When discussing RESTful APIs, try to include more detail about HTTP methods...";
                
                const userQuery = `Interview Track: ${currentTrack}\n\nQuestions and Answers:\n${userAnswers.map((item, index) => `Q${index+1}: ${item.question}\nA${index+1}: ${item.answer}`).join('\n\n')}`;
                
                const feedback = await callGemini(systemPrompt, userQuery);
                renderInterviewUI('report', feedback);
            }
            
            function openModal(modalEl) { modalEl.classList.remove('hidden'); }
            function closeModal(modalEl) { modalEl.classList.add('hidden'); }
            
            function showSuccessNotification(message) {
                notificationText.textContent = message;
                successNotification.classList.remove('translate-x-[120%]');
                setTimeout(() => { successNotification.classList.add('translate-x-[120%]'); }, 3000);
            }
            
            async function handleLogin(e) {
                e.preventDefault();
                showLoader(loginForm.querySelector('button[type="submit"]'));
                loginError.classList.add('hidden');
                const email = loginForm.querySelector('#login-email').value;
                const password = loginForm.querySelector('#login-password').value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    closeModal(loginModal);
                    loginForm.reset();
                    // onAuthStateChanged will handle the rest
                } catch(error) {
                    console.error("Login failed:", error.message);
                    loginError.textContent = "Failed to log in. Please check your email and password.";
                    loginError.classList.remove('hidden');
                } finally {
                    hideLoader(loginForm.querySelector('button[type="submit"]'));
                }
            }

            async function handleSignup(e) {
                e.preventDefault();
                showLoader(signupForm.querySelector('button[type="submit"]'));
                signupError.classList.add('hidden');
                const name = signupForm.querySelector('#signup-name').value;
                const email = signupForm.querySelector('#signup-email').value;
                const password = signupForm.querySelector('#signup-password').value;
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await updateProfile(userCredential.user, { displayName: name });
                    closeModal(signupModal);
                    signupForm.reset();
                    // onAuthStateChanged will handle the rest
                } catch (error) {
                    console.error("Signup failed:", error.message);
                    signupError.textContent = "Failed to create account. The email might be in use.";
                    signupError.classList.remove('hidden');
                } finally {
                    hideLoader(signupForm.querySelector('button[type="submit"]'));
                }
            }

            function handleLogout() {
                signOut(auth);
            }
            
            function updateAuthUI() {
                renderNav(); // Rerender nav on auth change
                if (isLoggedIn) {
                    authButtons.classList.add('hidden');
                    userGreeting.classList.remove('hidden');
                    userGreeting.classList.add('flex');
                    userNameEl.textContent = `Welcome, ${auth.currentUser.displayName}!`;
                } else {
                    authButtons.classList.remove('hidden');
                    userGreeting.classList.add('hidden');
                    userGreeting.classList.remove('flex');
                }
            }


            async function handleImproveResume() {
                aiHelperOutput.innerHTML = '<div class="flex justify-center items-center"><div class="loader" style="border-left-color: #8b5cf6;"></div></div>';
                aiHelperOutput.classList.remove('hidden');
                const content = resumeContent.value;
                if (!content.trim()) {
                    aiHelperOutput.innerHTML = '<p class="text-red-600">Please paste resume content.</p>';
                    return;
                }
                const systemPrompt = "You are a career coach. Analyze the resume and suggest 3-5 improvements for a tech internship. Focus on action verbs and quantifying achievements. Use markdown bullet points.";
                const suggestions = await callGemini(systemPrompt, content);
                aiHelperOutput.innerHTML = suggestions.replace(/\n/g, '<br>');
            }
             async function handleGenerateCoverLetter() {
                aiHelperOutput.innerHTML = '<div class="flex justify-center items-center"><div class="loader" style="border-left-color: #8b5cf6;"></div></div>';
                aiHelperOutput.classList.remove('hidden');
                const resume = resumeContent.value;
                const jobTitle = modalJobTitle.textContent;
                if (!resume.trim()) {
                    aiHelperOutput.innerHTML = '<p class="text-red-600">Please paste resume content first to generate a cover letter.</p>';
                    return;
                }
                 const systemPrompt = "You are a professional career writer. Based on the provided resume content and the target job title, write a concise, professional, and impactful cover letter. Address it generally (e.g., 'Dear Hiring Manager,'). The tone should be enthusiastic but professional. The letter should be about 3 paragraphs long.";
                 const userQuery = `Resume Content: ${resume}\n\nTarget Job: ${jobTitle}`;
                 const coverLetter = await callGemini(systemPrompt, userQuery);
                 aiHelperOutput.innerHTML = `<h4 class="font-bold mb-2">Suggested Cover Letter:</h4>${coverLetter.replace(/\n/g, '<br>')}`;
            }

            async function handleGeneratePath() {
                const goal = careerGoalInput.value;
                if (!goal.trim()) {
                    learningPathResult.innerHTML = '<p class="text-red-600">Please enter a career goal.</p>';
                    learningPathResult.classList.remove('hidden');
                    return;
                }
                showLoader(generatePathBtn);
                const systemPrompt = "You are an expert curriculum designer. Create a 4-6 step learning path based on the user's career goal. Directly start with the first numbered step. Format each step as a numbered list item, like '1. **Topic Name:** Justification...'. Do not use any other asterisks, introductory sentences, or markdown formatting.";
                const pathText = await callGemini(systemPrompt, goal);

                const pathHtml = pathText
                    .split('\n')
                    .filter(line => line.trim().length > 0)
                    .map(line => {
                        const content = line.replace(/^\d+\.\s*/, '');
                        const formattedContent = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                        return `<li class="mb-3">${formattedContent}</li>`;
                    })
                    .join('');

                learningPathResult.innerHTML = `<h4 class="text-2xl font-bold mb-4">Your Custom Path:</h4><ol class="list-decimal list-inside space-y-2">${pathHtml}</ol>`;
                learningPathResult.classList.remove('hidden');
                hideLoader(generatePathBtn);
            }
            async function handleGetDayInLife(jobTitle, company) {
                openModal(dayInLifeModal);
                dayModalJobTitle.textContent = jobTitle;
                dayInLifeContent.innerHTML = '<div class="flex justify-center items-center h-24"><div class="loader" style="border-left-color: #8b5cf6;"></div></div>';
                const systemPrompt = "You are a career advisor. In a short, engaging, and optimistic paragraph (around 80 words), describe a typical 'day in the life' for a specific intern role at a tech company. Focus on tasks, collaboration, and learning opportunities.";
                const userQuery = `Role: ${jobTitle}, Company Type: ${company}`;
                const description = await callGemini(systemPrompt, userQuery);
                dayInLifeContent.innerHTML = description.replace(/\n/g, '<br>');
            }

            function handleSearch(event) {
                const query = event.target.value.toLowerCase();
                
                const filteredInternships = internships.filter(internship => {
                    const skillsMatch = internship.skills.some(skill => skill.toLowerCase().includes(query));
                    return (
                        internship.title.toLowerCase().includes(query) ||
                        internship.company.toLowerCase().includes(query) ||
                        internship.location.toLowerCase().includes(query) ||
                        skillsMatch
                    );
                });

                populateAllInternships(filteredInternships);
                populateCarousel(filteredInternships);

                if (query.length > 0) {
                    const currentActiveView = document.querySelector('.view-section:not(.hidden)').id;
                     if (currentActiveView === 'home-view' || currentActiveView === 'dashboard-view') {
                         switchView('internships-view', true);
                     }
                }
            }
            
            // --- VOICE ASSISTANT ---
            function speak(text) {
                const utterance = new SpeechSynthesisUtterance(text);
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(utterance);
            }

            function setupSpeechRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    console.log("Speech Recognition not supported.");
                    return null;
                }
                const rec = new SpeechRecognition();
                rec.continuous = true;
                rec.interimResults = true;
                rec.lang = 'en-US';

                rec.onresult = (event) => {
                    const answerInput = document.getElementById('answer-input');
                    if (!answerInput) return;
                    
                    let interimTranscript = '';
                    let finalTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }
                    answerInput.value = finalTranscript + interimTranscript;
                };
                return rec;
            }

            function toggleListening() {
                const listenBtn = document.getElementById('listen-btn');
                const listenText = document.getElementById('listen-text');
                const micIcon = listenBtn.querySelector('i');

                if (recognition && recognition.isListening) {
                    recognition.stop();
                    recognition.isListening = false;
                    listenText.textContent = "Start Listening";
                    micIcon.classList.remove('fa-stop', 'text-red-500', 'listening-indicator');
                    micIcon.classList.add('fa-microphone');
                } else {
                    if(!recognition) recognition = setupSpeechRecognition();
                    if(recognition) {
                         recognition.start();
                         recognition.isListening = true;
                         listenText.textContent = "Stop Listening";
                         micIcon.classList.remove('fa-microphone');
                         micIcon.classList.add('fa-stop', 'text-red-500', 'listening-indicator');
                    } else {
                         listenText.textContent = "Not Supported";
                         listenBtn.disabled = true;
                    }
                }
            }

            // --- DASHBOARD ---
            function renderDashboard() {
                // Render Saved Internships
                if (savedInternships.length > 0) {
                    savedInternshipsContainer.innerHTML = savedInternships.map(id => {
                        const internship = internships.find(i => i.id === id);
                        return internship ? renderInternshipCard(internship) : '';
                    }).join('');
                } else {
                    savedInternshipsContainer.innerHTML = `<p class="text-slate-500">You haven't saved any internships yet.</p>`;
                }
                // Render Application History
                if (applicationHistoryContainer) {
                    if(appliedInternships.length > 0) {
                        applicationHistoryContainer.innerHTML = `
                            <table class="w-full text-left">
                                <thead class="border-b">
                                    <tr><th class="p-2">Role</th><th class="p-2">Company</th><th class="p-2">Status</th></tr>
                                </thead>
                                <tbody>
                                    ${appliedInternships.map(app => `
                                        <tr class="border-b">
                                            <td class="p-2 font-semibold">${app.title}</td>
                                            <td class="p-2">${app.company}</td>
                                            <td class="p-2"><span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${app.status}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                    } else {
                        applicationHistoryContainer.innerHTML = `<p class="text-slate-500 p-2">You haven't applied to any internships yet.</p>`;
                    }
                }
                // Render Badges
                if (myBadgesContainer) {
                    if (earnedBadges.length > 0) {
                        myBadgesContainer.innerHTML = earnedBadges.map(badge => `
                            <div class="flex items-center gap-2 bg-green-100 text-green-800 font-bold text-sm px-3 py-1.5 rounded-full">
                                <i class="fas fa-check-circle"></i>
                                <span>${badge}</span>
                            </div>
                        `).join('');
                    } else {
                        myBadgesContainer.innerHTML = `<p class="text-slate-500">No badges earned yet. Take a quiz to get your first one!</p>`;
                    }
                }
            }

            async function getAIRecommendations() {
                showLoader(getRecommendationsBtn);
                recommendationsResult.classList.remove('hidden');
                recommendationsResult.innerHTML = '<div class="flex justify-center items-center"><div class="loader" style="border-left-color: #8b5cf6;"></div></div>';
                
                const savedTitles = savedInternships.map(id => internships.find(i => i.id === id)?.title).filter(Boolean);
                const appliedTitles = appliedInternships.map(app => app.title);
                const interests = [...new Set([...savedTitles, ...appliedTitles])];

                if (interests.length === 0) {
                    recommendationsResult.innerHTML = `<p>Save or apply to internships to get personalized recommendations!</p>`;
                    hideLoader(getRecommendationsBtn);
                    return;
                }
                
                const systemPrompt = "You are a career recommendation engine. Based on the user's saved/applied internship titles, suggest 3 other relevant internship roles. Provide only the titles in a numbered list, without any extra text.";
                const userQuery = `Interested in: ${interests.join(', ')}`;
                const recommendations = await callGemini(systemPrompt, userQuery);
                recommendationsResult.innerHTML = recommendations.replace(/\n/g, '<br>');
                hideLoader(getRecommendationsBtn);
            }

            // --- QUIZ ---
            async function startQuiz() {
                if (!isLoggedIn) {
                    showSuccessNotification("Please log in to take a quiz.");
                    openModal(loginModal);
                    return;
                }
                openModal(quizModal);
                quizContainer.innerHTML = `<div class="text-center">
                    <h3 class="text-2xl font-bold text-slate-900 mb-6">Select a Quiz Topic</h3>
                    <div class="grid grid-cols-2 gap-4">
                        ${[...new Set(learningResources.map(r => r.category))].map(cat => `<button data-topic="${cat}" class="quiz-topic-btn p-4 border rounded-lg hover:bg-slate-100 font-semibold">${cat}</button>`).join('')}
                    </div>
                </div>`;
            }
            async function generateQuiz(topic) {
                quizContainer.innerHTML = '<div class="flex justify-center items-center h-48"><div class="loader" style="border-left-color: #8b5cf6; width: 40px; height: 40px;"></div></div>';
                const systemPrompt = "You are a quiz generator. Create a 3-question multiple-choice quiz on the given topic. For each question, provide 4 options (A, B, C, D). Crucially, after each question's options, you MUST include a line formatted exactly as `Correct: [LETTER]`, for example: `Correct: C`.";
                const quizText = await callGemini(systemPrompt, topic);
                renderQuiz(quizText, topic);
            }
            function renderQuiz(text, topic) {
                const questions = text.split('\n\n').filter(q => q.includes('?'));
                let quizHtml = `<h3 class="text-2xl font-bold text-slate-900 mb-6 text-center">Quiz: ${topic}</h3><form id="quiz-form" data-topic="${topic}" class="space-y-6">`;
                
                questions.forEach((q, index) => {
                    const lines = q.split('\n');
                    const questionText = lines[0];
                    const options = lines.slice(1, 5);
                    const correctLine = lines.find(l => l.startsWith('Correct:'));
                    const correctAnswer = correctLine ? correctLine.split(': ')[1].trim() : 'A';

                    quizHtml += `
                        <div>
                            <p class="font-semibold mb-2">${questionText}</p>
                            <div class="space-y-2" data-correct="${correctAnswer}">
                                ${options.map(opt => {
                                    const letter = opt.substring(0, 1);
                                    const text = opt.substring(3);
                                    return `
                                        <div>
                                            <input type="radio" name="q${index}" id="q${index}${letter}" value="${letter}" class="mr-2">
                                            <label for="q${index}${letter}">${text}</label>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                });

                quizHtml += `<div class="text-right"><button type="submit" class="text-white font-bold py-2 px-6 rounded-lg bg-gradient-to-r from-purple-600 to-pink-500">Submit</button></div></form>`;
                quizContainer.innerHTML = quizHtml;
            }

            async function handleQuizSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const topic = form.dataset.topic;
                let score = 0;
                const questions = form.querySelectorAll('div[data-correct]');
                questions.forEach((q, index) => {
                    const selected = form.querySelector(`input[name="q${index}"]:checked`);
                    if (selected && selected.value === q.dataset.correct) {
                        score++;
                    }
                });
                
                let resultHtml = '';
                if (score >= 2) {
                    const badgeName = `${topic} Fundamentals`;
                    if (!earnedBadges.includes(badgeName)) {
                         try {
                            const badgeRef = doc(db, `artifacts/${appId}/users/${currentUserId}/earnedBadges`, badgeName);
                            await setDoc(badgeRef, { name: badgeName, earnedAt: new Date() });
                            showSuccessNotification("Badge earned and saved!");
                         } catch (error) {
                             console.error("Error saving badge:", error);
                         }
                    }
                     resultHtml = `
                        <div class="text-center">
                            <i class="fas fa-award text-5xl text-yellow-500 mb-4"></i>
                            <h3 class="text-2xl font-bold text-slate-900 mb-2">Congratulations!</h3>
                            <p class="text-slate-600 mb-6">You scored ${score}/3 and earned the <strong>${badgeName}</strong> badge!</p>
                            <button class="close-quiz-modal-btn bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg">Close</button>
                        </div>
                    `;
                } else {
                     resultHtml = `
                        <div class="text-center">
                            <h3 class="text-2xl font-bold text-slate-900 mb-2">Keep Trying!</h3>
                            <p class="text-slate-600 mb-6">You scored ${score}/3. Review the learning materials and try again.</p>
                            <button class="close-quiz-modal-btn bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg">Close</button>
                        </div>
                    `;
                }
                quizContainer.innerHTML = resultHtml;
            }

            // --- FIRESTORE ACTIONS ---
            async function handleSaveInternship(jobId) {
                 if (!isLoggedIn) {
                    showSuccessNotification("Please log in to save internships.");
                    openModal(loginModal);
                    return;
                }
                const savedRef = doc(db, `artifacts/${appId}/users/${currentUserId}/savedInternships`, jobId);
                if (savedInternships.includes(jobId)) {
                    await deleteDoc(savedRef);
                } else {
                    await setDoc(savedRef, { savedAt: new Date() });
                }
                // UI will update via onSnapshot listener
            }

            // --- EVENT LISTENERS ---
            function renderNav() {
                const navItems = [
                    { name: 'Home', view: 'home-view', loggedIn: 'both' },
                    { name: 'Dashboard', view: 'dashboard-view', loggedIn: true },
                    { name: 'Internships', view: 'internships-view', loggedIn: 'both' },
                    { name: 'Learning Hub', view: 'learning-view', loggedIn: 'both' },
                    { name: 'Interview Prep', view: 'interview-view', loggedIn: 'both' },
                    { name: 'For Companies', view: 'company-view', loggedIn: 'both' }
                ];

                mainNav.innerHTML = navItems
                    .filter(item => item.loggedIn === 'both' || item.loggedIn === isLoggedIn)
                    .map(item => `<button data-view="${item.view}" data-nav="${item.view.replace('-view', '')}" class="nav-link">${item.name}</button>`)
                    .join('');
                
                mainNav.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', () => switchView(link.dataset.view)));
                
                // Set active link based on current view
                const visibleView = document.querySelector('.view-section:not(.hidden)');
                if (visibleView) {
                    const activeViewId = visibleView.id;
                    const activeLink = mainNav.querySelector(`.nav-link[data-view="${activeViewId}"]`);
                    if(activeLink) {
                        mainNav.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                        activeLink.classList.add('active');
                    }
                }
            }


            if(internshipPrevBtn) internshipPrevBtn.addEventListener('click', () => internshipCarousel.scrollBy({ left: -344, behavior: 'smooth' }));
            if(internshipNextBtn) internshipNextBtn.addEventListener('click', () => internshipCarousel.scrollBy({ left: 344, behavior: 'smooth' }));
            
            document.addEventListener('click', (e) => { 
                if (e.target.closest('.apply-btn')) { 
                    if (!isLoggedIn) {
                        showSuccessNotification("Please log in to apply.");
                        openModal(loginModal);
                        return;
                    }
                    openModal(applicationModal);
                    const jobId = e.target.closest('.apply-btn').dataset.jobId;
                    modalJobTitle.textContent = internships.find(i => i.id === jobId).title;
                    modalJobIdInput.value = jobId;
                }
                if (e.target.closest('.day-in-life-btn')) {
                    const btn = e.target.closest('.day-in-life-btn');
                    handleGetDayInLife(btn.dataset.jobTitle, btn.dataset.company);
                }
                if (e.target.closest('.close-modal-btn')) {
                    closeModal(e.target.closest('.modal-backdrop'));
                }
                 if(e.target.closest('.close-quiz-modal-btn')) {
                    closeModal(quizModal);
                }
                if(e.target.closest('.save-btn')) {
                    const btn = e.target.closest('.save-btn');
                    handleSaveInternship(btn.dataset.jobId);
                }
                if(e.target.closest('#take-quiz-btn')) {
                    startQuiz();
                }
                if(e.target.closest('.quiz-topic-btn')) {
                    generateQuiz(e.target.closest('.quiz-topic-btn').dataset.topic);
                }
            });

            quizContainer.addEventListener('submit', e => {
                if(e.target.id === 'quiz-form') {
                    handleQuizSubmit(e);
                }
            });


            if(loginBtnHeader) loginBtnHeader.addEventListener('click', () => openModal(loginModal));
            if(signupBtnHeader) signupBtnHeader.addEventListener('click', () => openModal(signupModal));
            if(logoutBtn) logoutBtn.addEventListener('click', handleLogout);

            if(loginForm) loginForm.addEventListener('submit', handleLogin);
            if(signupForm) signupForm.addEventListener('submit', handleSignup);
            
            document.querySelectorAll('.modal-backdrop').forEach(modalEl => {
                modalEl.addEventListener('click', e => { if (e.target === modalEl) closeModal(modalEl); });
            });

            if (sortTabsContainer) {
                sortTabsContainer.addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON') {
                        const sortBy = e.target.dataset.sort;

                        sortTabsContainer.querySelectorAll('button').forEach(btn => {
                            btn.classList.remove('active', 'text-slate-800', 'border-slate-800');
                            btn.classList.add('text-slate-500');
                        });
                        e.target.classList.add('active', 'text-slate-800', 'border-slate-800');
                        e.target.classList.remove('text-slate-500');

                        let sortedInternships = [...internships];

                        if (sortBy === 'rated') {
                            sortedInternships.sort((a, b) => b.rating - a.rating);
                        } else if (sortBy === 'newest') {
                            sortedInternships.sort((a, b) => new Date(b.postedDate) - new Date(a.postedDate));
                        } else { // 'popular'
                            sortedInternships.sort(() => Math.random() - 0.5);
                        }

                        populateCarousel(sortedInternships);
                        populateAllInternships(sortedInternships);
                    }
                });
            }

            applicationForm.addEventListener('submit', async e => { 
                e.preventDefault();
                const jobId = modalJobIdInput.value;
                const internship = internships.find(i => i.id === jobId);
                const applicationData = {
                    internshipId: jobId,
                    title: internship.title,
                    company: internship.company,
                    status: 'Applied',
                    appliedAt: new Date()
                };
                
                const collectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/appliedInternships`);
                await addDoc(collectionRef, applicationData);

                closeModal(applicationModal); 
                showSuccessNotification("Application Submitted!"); 
                // UI will update via onSnapshot
            });

            improveResumeBtn.addEventListener('click', handleImproveResume);
            generateCoverLetterBtn.addEventListener('click', handleGenerateCoverLetter);
            generatePathBtn.addEventListener('click', handleGeneratePath);
            if(searchBar) searchBar.addEventListener('input', handleSearch);
            if(getRecommendationsBtn) getRecommendationsBtn.addEventListener('click', getAIRecommendations);

            // --- FIREBASE INITIALIZATION & AUTH STATE HANDLING ---
            function cleanupFirestoreListeners() {
                firestoreUnsubscribers.forEach(unsub => unsub());
                firestoreUnsubscribers = [];
            }
            
            function setupFirestoreListeners(uid) {
                cleanupFirestoreListeners(); // Clean up previous listeners if any

                const savedRef = collection(db, `artifacts/${appId}/users/${uid}/savedInternships`);
                const savedUnsub = onSnapshot(savedRef, (snapshot) => {
                    savedInternships = snapshot.docs.map(doc => doc.id);
                    populateAllInternships();
                    populateCarousel();
                    renderDashboard();
                });

                const appliedRef = collection(db, `artifacts/${appId}/users/${uid}/appliedInternships`);
                const appliedUnsub = onSnapshot(appliedRef, (snapshot) => {
                    appliedInternships = snapshot.docs.map(doc => doc.data());
                    renderDashboard();
                });
                
                const badgesRef = collection(db, `artifacts/${appId}/users/${uid}/earnedBadges`);
                const badgesUnsub = onSnapshot(badgesRef, (snapshot) => {
                    earnedBadges = snapshot.docs.map(doc => doc.data().name);
                    renderDashboard();
                });

                firestoreUnsubscribers.push(savedUnsub, appliedUnsub, badgesUnsub);
            }

            async function initializeFirebase() {
                 try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    setLogLevel('debug');

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            isLoggedIn = true;
                            currentUserId = user.uid;
                            updateAuthUI();
                            setupFirestoreListeners(user.uid);
                            showSuccessNotification(`Welcome, ${user.displayName || user.email}!`);
                        } else {
                            isLoggedIn = false;
                            currentUserId = null;
                            cleanupFirestoreListeners();
                            // Clear local data
                            savedInternships = [];
                            appliedInternships = [];
                            earnedBadges = [];
                            // Update UI for logged-out state
                            updateAuthUI();
                            populateAllInternships();
                            populateCarousel();
                            renderDashboard();
                            switchView('home-view');
                        }
                    });

                    // Sign in with token if available, otherwise anonymously
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }

                 } catch (error) {
                     console.error("Firebase initialization failed:", error);
                 }
            }


            // --- APP INITIALIZATION ---
            initializeFirebase();
            populateAllInternships();
            populateCarousel();
            renderLearningResources();
            renderInterviewUI('selection');
            renderNav();
            switchView('home-view');
        });
    </script>
</body>
</html>

